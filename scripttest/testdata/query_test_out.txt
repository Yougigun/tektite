set max_line_width 300;
OK
--create topic test_topic 16;

test_stream :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

test_table := test_stream -> (store table by key);
OK

test_agg := test_stream -> (aggregate sum(v0) by key);
OK

--create topic test_topic2 16;

test_stream_one_row :=
(bridge from
    test_topic2
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

--load data dataset_1;

--load data dataset_2;

-- test scan all;

-- no sort;

(scan all from test_stream_one_row);
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | key                           | v0                   | v1                            | v2                            | v3                            | v4                            | v5                            | v6                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | key01                         | 1000                 | 1.230000                      | true                          | 12345678.765432               | foobar01                      | somebytes01                   | 2008-04-03 23:21:17.123000 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(scan all from test_stream) -> (sort by key);
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | key                           | v0                   | v1                            | v2                            | v3                            | v4                            | v5                            | v6                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | key01                         | 1000                 | 1.230000                      | true                          | 12345678.765432               | foobar01                      | somebytes01                   | 2008-04-03 23:21:17.123000 |
| 0                    | 2006-01-02 15:05:05.000000 | key02                         | 1001                 | 2.230000                      | false                         | 22345678.765432               | foobar02                      | somebytes02                   | 2008-04-03 23:22:17.123000 |
| 0                    | 2006-01-02 15:06:05.000000 | key03                         | 1002                 | 3.230000                      | true                          | 32345678.765432               | foobar03                      | somebytes03                   | 2008-04-03 23:23:17.123000 |
| 0                    | 2006-01-02 15:07:05.000000 | key04                         | 1003                 | 4.230000                      | false                         | 42345678.765432               | foobar04                      | somebytes04                   | 2008-04-03 23:24:17.123000 |
| 0                    | 2006-01-02 15:08:05.000000 | key05                         | 1004                 | 5.230000                      | true                          | 52345678.765432               | foobar05                      | somebytes05                   | 2008-04-03 23:25:17.123000 |
| 0                    | 2006-01-02 15:09:05.000000 | key06                         | 1005                 | 6.230000                      | false                         | 62345678.765432               | foobar06                      | somebytes06                   | 2008-04-03 23:26:17.123000 |
| 0                    | 2006-01-02 15:10:05.000000 | key07                         | 1006                 | 7.230000                      | true                          | 72345678.765432               | foobar07                      | somebytes07                   | 2008-04-03 23:27:17.123000 |
| 1                    | 2006-01-02 15:11:05.000000 | key08                         | 1007                 | 8.230000                      | false                         | 82345678.765432               | foobar08                      | somebytes08                   | 2008-04-03 23:28:17.123000 |
| 0                    | 2006-01-02 15:12:05.000000 | key09                         | 1008                 | 9.230000                      | true                          | 92345678.765432               | foobar09                      | somebytes09                   | 2008-04-03 23:29:17.123000 |
| 0                    | 2006-01-02 15:13:05.000000 | key10                         | 1009                 | 10.230000                     | false                         | 102345678.765432              | foobar10                      | somebytes10                   | 2008-04-03 23:30:17.123000 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

-- scan all using columns - shouldn't have offset and event_time;

(scan all from test_stream) -> (project v0, v1, v2) -> (sort by v0);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| v0                   | v1                                                                                                                                      | v2                                                                                                                                      |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 1000                 | 1.230000                                                                                                                                | true                                                                                                                                    |
| 1001                 | 2.230000                                                                                                                                | false                                                                                                                                   |
| 1002                 | 3.230000                                                                                                                                | true                                                                                                                                    |
| 1003                 | 4.230000                                                                                                                                | false                                                                                                                                   |
| 1004                 | 5.230000                                                                                                                                | true                                                                                                                                    |
| 1005                 | 6.230000                                                                                                                                | false                                                                                                                                   |
| 1006                 | 7.230000                                                                                                                                | true                                                                                                                                    |
| 1007                 | 8.230000                                                                                                                                | false                                                                                                                                   |
| 1008                 | 9.230000                                                                                                                                | true                                                                                                                                    |
| 1009                 | 10.230000                                                                                                                               | false                                                                                                                                   |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

(scan all from test_agg) -> (sort by key);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                                                                                                                                                                                                                                                  | sum(v0)              |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                                                                | 1000                 |
| 2006-01-02 15:05:05.000000 | key02                                                                                                                                                                                                                                                | 1001                 |
| 2006-01-02 15:06:05.000000 | key03                                                                                                                                                                                                                                                | 1002                 |
| 2006-01-02 15:07:05.000000 | key04                                                                                                                                                                                                                                                | 1003                 |
| 2006-01-02 15:08:05.000000 | key05                                                                                                                                                                                                                                                | 1004                 |
| 2006-01-02 15:09:05.000000 | key06                                                                                                                                                                                                                                                | 1005                 |
| 2006-01-02 15:10:05.000000 | key07                                                                                                                                                                                                                                                | 1006                 |
| 2006-01-02 15:11:05.000000 | key08                                                                                                                                                                                                                                                | 1007                 |
| 2006-01-02 15:12:05.000000 | key09                                                                                                                                                                                                                                                | 1008                 |
| 2006-01-02 15:13:05.000000 | key10                                                                                                                                                                                                                                                | 1009                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

(scan all from test_table) -> (sort by key);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                             | 1000                 | 1.230000                          | true                              | 12345678.765432                   | foobar01                          | somebytes01                       | 2008-04-03 23:21:17.123000 |
| 2006-01-02 15:05:05.000000 | key02                             | 1001                 | 2.230000                          | false                             | 22345678.765432                   | foobar02                          | somebytes02                       | 2008-04-03 23:22:17.123000 |
| 2006-01-02 15:06:05.000000 | key03                             | 1002                 | 3.230000                          | true                              | 32345678.765432                   | foobar03                          | somebytes03                       | 2008-04-03 23:23:17.123000 |
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
| 2006-01-02 15:12:05.000000 | key09                             | 1008                 | 9.230000                          | true                              | 92345678.765432                   | foobar09                          | somebytes09                       | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:13:05.000000 | key10                             | 1009                 | 10.230000                         | false                             | 102345678.765432                  | foobar10                          | somebytes10                       | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

(scan all from test_table) -> (filter by v0 != 1000) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:05:05.000000 | key02                             | 1001                 | 2.230000                          | false                             | 22345678.765432                   | foobar02                          | somebytes02                       | 2008-04-03 23:22:17.123000 |
| 2006-01-02 15:06:05.000000 | key03                             | 1002                 | 3.230000                          | true                              | 32345678.765432                   | foobar03                          | somebytes03                       | 2008-04-03 23:23:17.123000 |
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
| 2006-01-02 15:12:05.000000 | key09                             | 1008                 | 9.230000                          | true                              | 92345678.765432                   | foobar09                          | somebytes09                       | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:13:05.000000 | key10                             | 1009                 | 10.230000                         | false                             | 102345678.765432                  | foobar10                          | somebytes10                       | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
9 rows returned

delete(test_agg);
OK
delete(test_table);
OK
delete(test_stream);
OK
delete(test_stream_one_row);
OK

--delete topic test_topic2;
--delete topic test_topic;

-- get operator;

--create topic test_topic 16;

test_stream :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

test_table0 := test_stream -> (partition by v0 partitions=10) -> (store table by v0);
OK
test_table1 := test_stream -> (partition by v1 partitions=10) -> (store table by v1);
OK
test_table2 := test_stream -> (partition by v2 partitions=10) -> (store table by v2);
OK
test_table3 := test_stream -> (partition by v3 partitions=10) -> (store table by v3);
OK
test_table4 := test_stream -> (partition by v4 partitions=10) -> (store table by v4);
OK
test_table5 := test_stream -> (partition by v5 partitions=10) -> (store table by v5);
OK
test_table6 := test_stream -> (partition by v6 partitions=10) -> (store table by v6);
OK

test_agg := test_stream -> (partition by v0 partitions=10) -> (aggregate sum(v1) by v0);
OK

--load data dataset_1;

(get 1005 from test_table0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get 9.23f from test_table1);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:12:05.000000 | key09                             | 1008                 | 9.230000                          | true                              | 92345678.765432                   | foobar09                          | somebytes09                       | 2008-04-03 23:29:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get to_decimal("32345678.7654321", 38, 6) from test_table3);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:06:05.000000 | key03                             | 1002                 | 3.230000                          | true                              | 32345678.765432                   | foobar03                          | somebytes03                       | 2008-04-03 23:23:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get "foobar08" from test_table4);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get to_bytes("somebytes04") from test_table5);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get parse_date("2008-04-03 23:22:17.123", "2006-01-02 15:04:05.999999") from test_table6);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:05:05.000000 | key02                             | 1001                 | 2.230000                          | false                             | 22345678.765432                   | foobar02                          | somebytes02                       | 2008-04-03 23:22:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get 1005 from test_agg);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | v0                   | sum(v1)                                                                                                                                                                                                                                              |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:09:05.000000 | 1005                 | 6.230000                                                                                                                                                                                                                                             |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

(get "foobar08" from test_table4) -> (filter by v1 == 8.23f);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

-- scan;

(scan 1003 to 1008 from test_table0) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
5 rows returned

(scan 1003 to end from test_table0) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
| 2006-01-02 15:12:05.000000 | key09                             | 1008                 | 9.230000                          | true                              | 92345678.765432                   | foobar09                          | somebytes09                       | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:13:05.000000 | key10                             | 1009                 | 10.230000                         | false                             | 102345678.765432                  | foobar10                          | somebytes10                       | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
7 rows returned

(scan start to 1008 from test_table0) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                             | 1000                 | 1.230000                          | true                              | 12345678.765432                   | foobar01                          | somebytes01                       | 2008-04-03 23:21:17.123000 |
| 2006-01-02 15:05:05.000000 | key02                             | 1001                 | 2.230000                          | false                             | 22345678.765432                   | foobar02                          | somebytes02                       | 2008-04-03 23:22:17.123000 |
| 2006-01-02 15:06:05.000000 | key03                             | 1002                 | 3.230000                          | true                              | 32345678.765432                   | foobar03                          | somebytes03                       | 2008-04-03 23:23:17.123000 |
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
8 rows returned

(scan 1003 to 1008 incl from test_table0) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:07:05.000000 | key04                             | 1003                 | 4.230000                          | false                             | 42345678.765432                   | foobar04                          | somebytes04                       | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
| 2006-01-02 15:12:05.000000 | key09                             | 1008                 | 9.230000                          | true                              | 92345678.765432                   | foobar09                          | somebytes09                       | 2008-04-03 23:29:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

(scan 1003 excl to 1008 from test_table0) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                               | v0                   | v1                                | v2                                | v3                                | v4                                | v5                                | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:08:05.000000 | key05                             | 1004                 | 5.230000                          | true                              | 52345678.765432                   | foobar05                          | somebytes05                       | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:09:05.000000 | key06                             | 1005                 | 6.230000                          | false                             | 62345678.765432                   | foobar06                          | somebytes06                       | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:10:05.000000 | key07                             | 1006                 | 7.230000                          | true                              | 72345678.765432                   | foobar07                          | somebytes07                       | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:11:05.000000 | key08                             | 1007                 | 8.230000                          | false                             | 82345678.765432                   | foobar08                          | somebytes08                       | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
4 rows returned

-- TODO rest of column types;

delete(test_table6);
OK
delete(test_table5);
OK
delete(test_table4);
OK
delete(test_table3);
OK
delete(test_table2);
OK
delete(test_table1);
OK
delete(test_table0);
OK
delete(test_agg);
OK
delete(test_stream);
OK

--delete topic test_topic;

-- get with composite key;

--create topic test_topic 16;

test_stream :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_int("v1",val) as v1,
    json_int("v2",val) as v2)
-> (store stream);
OK

test_table := test_stream -> (partition by v0,v1 partitions=10) -> (store table by v0,v1);
OK

--load data dataset_3;

(scan all from test_table) -> (sort by v0,v1);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                                                                                                                                                                                                    | v0                   | v1                   | v2                   |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 1000                 | 1000                 | 1000                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 1000                 | 2000                 | 1001                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 1000                 | 3000                 | 1002                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 1000                 | 1003                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 2000                 | 1004                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 3000                 | 1005                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 3000                 | 1000                 | 1006                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 3000                 | 2000                 | 1007                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 3000                 | 3000                 | 1008                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 3000                 | 4000                 | 1009                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

(get 1000 from test_table) -> (sort by v0,v1);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                                                                                                                                                                                                    | v0                   | v1                   | v2                   |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 1000                 | 1000                 | 1000                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 1000                 | 2000                 | 1001                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 1000                 | 3000                 | 1002                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
3 rows returned
(get 2000 from test_table) -> (sort by v0,v1);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                                                                                                                                                                                                    | v0                   | v1                   | v2                   |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 1000                 | 1003                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 2000                 | 1004                 |
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 3000                 | 1005                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
3 rows returned

(get 2000, 3000 from test_table);
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | key                                                                                                                                                                                                    | v0                   | v1                   | v2                   |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:04:05.000000 | key01                                                                                                                                                                                                  | 2000                 | 3000                 | 1005                 |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

delete(test_table);
OK
delete(test_stream);
OK
--delete topic test_topic;



-- query errors;

stream1 :=
(bridge from
    test_topic
    partitions = 10
    props = ()
) -> (store table by key);
OK

-- unknown sort column;

(scan all from stream1) -> (sort by foo);
unknown column 'foo'. (available columns: event_time: timestamp, key: bytes, hdrs: bytes, val: bytes) (line 1 column 37):
(scan all from stream1) -> (sort by foo)
                                    ^

-- sort must be last operator;

(scan all from stream1) -> (sort by key) -> (filter by key == 2);
sort must be the last operator in a query (line 1 column 29):
(scan all from stream1) -> (sort by key) -> (filter by key == 2)
                            ^

-- no partition in query;

(scan all from stream1) -> (partition by key partitions=10) -> (sort by key);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'partition' (line 1 column 29):
(scan all from stream1) -> (partition by key partitions=10) -> (sort by key)
                            ^

(scan all from stream1) -> (partition by key partitions=10);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'partition' (line 1 column 29):
(scan all from stream1) -> (partition by key partitions=10)
                            ^

-- no aggregate in query;

(scan all from stream1) -> (aggregate sum(val) by key) -> (sort by key);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'aggregate' (line 1 column 29):
(scan all from stream1) -> (aggregate sum(val) by key) -> (sort by key)
                            ^

(scan all from stream1) -> (aggregate sum(val) by key);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'aggregate' (line 1 column 29):
(scan all from stream1) -> (aggregate sum(val) by key)
                            ^

-- no (store stream) in query;

(scan all from stream1) -> (store stream);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'store' (line 1 column 29):
(scan all from stream1) -> (store stream)
                            ^

(scan all from stream1) -> (store stream) -> (sort by key);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'store' (line 1 column 29):
(scan all from stream1) -> (store stream) -> (sort by key)
                            ^

-- no table in query;

(scan all from stream1) -> (store table by key);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'store' (line 1 column 29):
(scan all from stream1) -> (store table by key)
                            ^

(scan all from stream1) -> (store table by key) -> (sort by key);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'store' (line 1 column 29):
(scan all from stream1) -> (store table by key) -> (sort by key)
                            ^

-- no bridge from in query;

(scan all from stream1)
-> (bridge from
  test_topic
  partitions = 10
  props = (

  )
);
expected one of: 'get', 'scan', 'project', 'filter', 'sort' but found 'bridge' (line 2 column 5):
-> (bridge from
    ^

delete(stream1);
OK

-- cannot execute get on stream;

stream2 :=
(bridge from
    test_topic
    partitions = 10
    props = ()
) -> (store stream);
OK

(get 1 from stream2);
unknown table 'stream2' (line 1 column 13):
(get 1 from stream2)
            ^

(scan 1 to 10 from stream2);
unknown table 'stream2' (line 1 column 20):
(scan 1 to 10 from stream2)
                   ^

delete(stream2);
OK
