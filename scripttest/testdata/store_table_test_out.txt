set max_line_width 200;
OK
--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key as pk,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store table by pk);
OK

--load data dataset_1;

(scan all from stream1) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:10:05.000000 | key01            | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:07:05.000000 | key04            | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:13:05.000000 | key06            | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 2006-01-02 15:11:05.000000 | key08            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

-- load more data;

--load data dataset_2;

(scan all from stream1) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:10:05.000000 | key01            | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:05:05.000000 | key03            | 1011                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| 2006-01-02 15:07:05.000000 | key04            | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:04:05.000000 | key06            | 1010                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| 2006-01-02 15:11:05.000000 | key08            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| 2006-01-02 15:06:05.000000 | key11            | 1020                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
8 rows returned

delete(stream1);
OK

--delete topic test_topic;

-- composite key;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key as pk,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store table by pk, v0);
OK

--load data dataset_3;

(scan all from stream1) -> (sort by pk, v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:05:05.000000 | key01            | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| 2006-01-02 15:06:05.000000 | key01            | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| 2006-01-02 15:11:05.000000 | key01            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| 2006-01-02 15:09:05.000000 | key02            | 1000                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| 2006-01-02 15:08:05.000000 | key02            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:13:05.000000 | key03            | 1000                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
7 rows returned

delete(stream1);
OK

--delete topic test_topic;

--- with continuation;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key as pk,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

stream2 := stream1 -> (store table by pk);
OK

stream3 := stream1 -> (store table by pk);
OK

--load data dataset_1;

(scan all from stream2) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:10:05.000000 | key01            | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:07:05.000000 | key04            | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:13:05.000000 | key06            | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 2006-01-02 15:11:05.000000 | key08            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

(scan all from stream3) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:10:05.000000 | key01            | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:07:05.000000 | key04            | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:13:05.000000 | key06            | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 2006-01-02 15:11:05.000000 | key08            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

-- check data there after restart;
--restart cluster;
set max_line_width 200;
OK

(scan all from stream2) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:10:05.000000 | key01            | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:07:05.000000 | key04            | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:13:05.000000 | key06            | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 2006-01-02 15:11:05.000000 | key08            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

(scan all from stream3) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:10:05.000000 | key01            | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2006-01-02 15:12:05.000000 | key02            | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 2006-01-02 15:07:05.000000 | key04            | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 2006-01-02 15:08:05.000000 | key05            | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 2006-01-02 15:13:05.000000 | key06            | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 2006-01-02 15:11:05.000000 | key08            | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

-- errors;

-- try and create stream with table as not the last operator, should fail;

should_fail := stream1 -> (store table by pk) -> (store stream);
'store table' must be the last operator in a stream (line 1 column 28):
should_fail := stream1 -> (store table by pk) -> (store stream)
                           ^

delete(stream3);
OK
delete(stream2);
OK
delete(stream1);
OK

--delete topic test_topic;

-- use an empty key for the table - this means only a single row is maintained - this is useful for storing results of
-- aggregations which don't group by any keys;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key as pk,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store table);
OK

--load data dataset_4;

(scan all from stream1) -> (sort by pk);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| event_time                 | pk               | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 2006-01-02 15:06:05.000000 | key01            | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row returned

delete(stream1);
OK

-- errors;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
) -> (store table by foo);
cannot use key column 'foo' - it is not a known column in the incoming schema (line 6 column 7):
) -> (store table by foo)
      ^

--delete topic test_topic;
