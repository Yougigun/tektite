set max_line_width 300;
OK
--create topic test_topic 16;

test_stream :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

child_stream1 := test_stream -> (filter by v0 > 1003) -> (store stream);
OK

child_stream2 := test_stream -> (filter by v0 > 1004) -> (store stream);
OK

child_stream3 := child_stream2 -> (filter by v0 > 1007) -> (store stream);
OK

--load data dataset_1;

(scan all from child_stream1) -> (sort by key);
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | key                           | v0                   | v1                            | v2                            | v3                            | v4                            | v5                            | v6                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:08:05.000000 | key05                         | 1004                 | 5.230000                      | true                          | 52345678.765432               | foobar05                      | somebytes05                   | 2008-04-03 23:25:17.123000 |
| 0                    | 2006-01-02 15:09:05.000000 | key06                         | 1005                 | 6.230000                      | false                         | 62345678.765432               | foobar06                      | somebytes06                   | 2008-04-03 23:26:17.123000 |
| 0                    | 2006-01-02 15:10:05.000000 | key07                         | 1006                 | 7.230000                      | true                          | 72345678.765432               | foobar07                      | somebytes07                   | 2008-04-03 23:27:17.123000 |
| 1                    | 2006-01-02 15:11:05.000000 | key08                         | 1007                 | 8.230000                      | false                         | 82345678.765432               | foobar08                      | somebytes08                   | 2008-04-03 23:28:17.123000 |
| 0                    | 2006-01-02 15:12:05.000000 | key09                         | 1008                 | 9.230000                      | true                          | 92345678.765432               | foobar09                      | somebytes09                   | 2008-04-03 23:29:17.123000 |
| 0                    | 2006-01-02 15:13:05.000000 | key10                         | 1009                 | 10.230000                     | false                         | 102345678.765432              | foobar10                      | somebytes10                   | 2008-04-03 23:30:17.123000 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
6 rows returned

(scan all from child_stream2) -> (sort by key);
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | key                           | v0                   | v1                            | v2                            | v3                            | v4                            | v5                            | v6                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:09:05.000000 | key06                         | 1005                 | 6.230000                      | false                         | 62345678.765432               | foobar06                      | somebytes06                   | 2008-04-03 23:26:17.123000 |
| 0                    | 2006-01-02 15:10:05.000000 | key07                         | 1006                 | 7.230000                      | true                          | 72345678.765432               | foobar07                      | somebytes07                   | 2008-04-03 23:27:17.123000 |
| 1                    | 2006-01-02 15:11:05.000000 | key08                         | 1007                 | 8.230000                      | false                         | 82345678.765432               | foobar08                      | somebytes08                   | 2008-04-03 23:28:17.123000 |
| 0                    | 2006-01-02 15:12:05.000000 | key09                         | 1008                 | 9.230000                      | true                          | 92345678.765432               | foobar09                      | somebytes09                   | 2008-04-03 23:29:17.123000 |
| 0                    | 2006-01-02 15:13:05.000000 | key10                         | 1009                 | 10.230000                     | false                         | 102345678.765432              | foobar10                      | somebytes10                   | 2008-04-03 23:30:17.123000 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
5 rows returned

(scan all from child_stream3) -> (sort by key);
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | key                           | v0                   | v1                            | v2                            | v3                            | v4                            | v5                            | v6                         |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:12:05.000000 | key09                         | 1008                 | 9.230000                      | true                          | 92345678.765432               | foobar09                      | somebytes09                   | 2008-04-03 23:29:17.123000 |
| 0                    | 2006-01-02 15:13:05.000000 | key10                         | 1009                 | 10.230000                     | false                         | 102345678.765432              | foobar10                      | somebytes10                   | 2008-04-03 23:30:17.123000 |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
2 rows returned

-- should fail: cannot delete when child exists;
delete(test_stream);
cannot delete stream test_stream - it has child streams: [child_stream1 child_stream2] - they must be deleted first (line 1 column 8):
delete(test_stream)
       ^

-- should fail: cannot delete when child exists;
delete(child_stream2);
cannot delete stream child_stream2 - it has child streams: [child_stream3] - they must be deleted first (line 1 column 8):
delete(child_stream2)
       ^

delete(child_stream3);
OK

delete(child_stream2);
OK

-- should fail: cannot delete when child exists;
delete(test_stream);
cannot delete stream test_stream - it has child streams: [child_stream1] - they must be deleted first (line 1 column 8):
delete(test_stream)
       ^

delete(child_stream1);
OK

delete(test_stream);
OK

-- error - unknown parent stream;

child_stream1 := unknown_stream -> (store stream);
unknown parent stream 'unknown_stream' (line 1 column 18):
child_stream1 := unknown_stream -> (store stream)
                 ^

--delete topic test_topic;
