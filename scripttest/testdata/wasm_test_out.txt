set max_line_width 400;
OK

--create topic test_topic 16;

register_wasm("testdata/wasm/test_mod1/test_mod1.wasm");
OK

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    event_time as event_time2,
    offset as offset2,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

-- test with wasm functions in projection - we test with all param types and return types;

stream2 := stream1 ->
(project
    v0,
    test_mod1.funcArgsAllTypes(v0, v1, v2, v3, v4, v5, v6) as all_str
    ) -> (store stream);
OK

stream3 := stream1 ->
(project
    v0,
    test_mod1.funcIntReturn(v0) as rv0,
    test_mod1.funcFloatReturn(v1) as rv1,
    test_mod1.funcBoolReturn(v2) as rv2,
    test_mod1.funcDecimalReturn(v3) as rv3,
    test_mod1.funcStringReturn(v4) as rv4,
    test_mod1.funcBytesReturn(v5) as rv5,
    test_mod1.funcTimestampReturn(v6) as rv6
    ) -> (store stream);
OK

-- test with wasm function in filter;

register_wasm("testdata/wasm/test_mod2/test_mod2.wasm");
OK

stream4 := stream1 -> (project v0) -> (filter by test_mod2.filterFunc(v0)) -> (store stream);
OK

--load data dataset_1;

(scan all from stream2) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | all_str                                                                                                                                                                                                                                                                                                                           |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1000 1.23 true 12345678.765432 foobar01 [115 111 109 101 98 121 116 101 115 48 49] 1207264877123                                                                                                                                                                                                                                  |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 1001 2.23 false 22345678.765432 foobar02 [115 111 109 101 98 121 116 101 115 48 50] 1207264937123                                                                                                                                                                                                                                 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 1002 3.23 true 32345678.765432 foobar03 [115 111 109 101 98 121 116 101 115 48 51] 1207264997123                                                                                                                                                                                                                                  |
| 0                    | 2006-01-02 15:07:05.000000 | 1003                 | 1003 4.23 false 42345678.765432 foobar04 [115 111 109 101 98 121 116 101 115 48 52] 1207265057123                                                                                                                                                                                                                                 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 1004 5.23 true 52345678.765432 foobar05 [115 111 109 101 98 121 116 101 115 48 53] 1207265117123                                                                                                                                                                                                                                  |
| 0                    | 2006-01-02 15:09:05.000000 | 1005                 | 1005 6.23 false 62345678.765432 foobar06 [115 111 109 101 98 121 116 101 115 48 54] 1207265177123                                                                                                                                                                                                                                 |
| 0                    | 2006-01-02 15:10:05.000000 | 1006                 | 1006 7.23 true 72345678.765432 foobar07 [115 111 109 101 98 121 116 101 115 48 55] 1207265237123                                                                                                                                                                                                                                  |
| 1                    | 2006-01-02 15:11:05.000000 | 1007                 | 1007 8.23 false 82345678.765432 foobar08 [115 111 109 101 98 121 116 101 115 48 56] 1207265297123                                                                                                                                                                                                                                 |
| 0                    | 2006-01-02 15:12:05.000000 | 1008                 | 1008 9.23 true 92345678.765432 foobar09 [115 111 109 101 98 121 116 101 115 48 57] 1207265357123                                                                                                                                                                                                                                  |
| 0                    | 2006-01-02 15:13:05.000000 | 1009                 | 1009 10.23 false 102345678.765432 foobar10 [115 111 109 101 98 121 116 101 115 49 48] 1207265417123                                                                                                                                                                                                                               |
| 1                    | 2006-01-02 15:14:05.000000 | 1010                 | 1010 11.23 true 112345678.765432 foobar11 [115 111 109 101 98 121 116 101 115 48 49 49] 1207265477123                                                                                                                                                                                                                             |
| 1                    | 2006-01-02 15:15:05.000000 | 1011                 | 1011 12.23 false 122345678.765432 foobar12 [115 111 109 101 98 121 116 101 115 49 50] 1207265537123                                                                                                                                                                                                                               |
| 0                    | 2006-01-02 15:16:05.000000 | 1012                 | 1012 13.23 true 132345678.765432 foobar13 [115 111 109 101 98 121 116 101 115 49 51] 1207265597123                                                                                                                                                                                                                                |
| 1                    | 2006-01-02 15:17:05.000000 | 1013                 | 1013 14.23 false 142345678.765432 foobar14 [115 111 109 101 98 121 116 101 115 49 52] 1207265657123                                                                                                                                                                                                                               |
| 2                    | 2006-01-02 15:18:05.000000 | 1014                 | 1014 15.23 true 152345678.765432 foobar15 [115 111 109 101 98 121 116 101 115 49 53] 1207265717123                                                                                                                                                                                                                                |
| 0                    | 2006-01-02 15:19:05.000000 | 1015                 | 1015 16.23 false 162345678.765432 foobar16 [115 111 109 101 98 121 116 101 115 49 54] 1207265777123                                                                                                                                                                                                                               |
| 3                    | 2006-01-02 15:20:05.000000 | 1016                 | 1016 17.23 true 172345678.765432 foobar17 [115 111 109 101 98 121 116 101 115 49 55] 1207265837123                                                                                                                                                                                                                                |
| 1                    | 2006-01-02 15:21:05.000000 | 1017                 | 1017 18.23 false 182345678.765432 foobar18 [115 111 109 101 98 121 116 101 115 49 56] 1207265897123                                                                                                                                                                                                                               |
| 2                    | 2006-01-02 15:22:05.000000 | 1018                 | 1018 19.23 true 192345678.765432 foobar19 [115 111 109 101 98 121 116 101 115 49 57] 1207265957123                                                                                                                                                                                                                                |
| 2                    | 2006-01-02 15:23:05.000000 | 1020                 | 1020 20.23 false 202345678.765432 foobar20 [115 111 109 101 98 121 116 101 115 50 48] 1207266017123                                                                                                                                                                                                                               |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

(scan all from stream3) -> (sort by v0);
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | rv0                  | rv1                                                 | rv2                                                 | rv3                                                 | rv4                                                 | rv5                                                 | rv6                        |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1001                 | 2.230000                                            | false                                               | 712345678.765432                                    | FOOBAR01                                            | SOMEBYTES01                                         | 2008-04-03 23:21:17.124000 |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 1002                 | 3.230000                                            | true                                                | 722345678.765432                                    | FOOBAR02                                            | SOMEBYTES02                                         | 2008-04-03 23:22:17.124000 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 1003                 | 4.230000                                            | false                                               | 732345678.765432                                    | FOOBAR03                                            | SOMEBYTES03                                         | 2008-04-03 23:23:17.124000 |
| 0                    | 2006-01-02 15:07:05.000000 | 1003                 | 1004                 | 5.230000                                            | true                                                | 742345678.765432                                    | FOOBAR04                                            | SOMEBYTES04                                         | 2008-04-03 23:24:17.124000 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 1005                 | 6.230000                                            | false                                               | 752345678.765432                                    | FOOBAR05                                            | SOMEBYTES05                                         | 2008-04-03 23:25:17.124000 |
| 0                    | 2006-01-02 15:09:05.000000 | 1005                 | 1006                 | 7.230000                                            | true                                                | 762345678.765432                                    | FOOBAR06                                            | SOMEBYTES06                                         | 2008-04-03 23:26:17.124000 |
| 0                    | 2006-01-02 15:10:05.000000 | 1006                 | 1007                 | 8.230000                                            | false                                               | 772345678.765432                                    | FOOBAR07                                            | SOMEBYTES07                                         | 2008-04-03 23:27:17.124000 |
| 1                    | 2006-01-02 15:11:05.000000 | 1007                 | 1008                 | 9.230000                                            | true                                                | 782345678.765432                                    | FOOBAR08                                            | SOMEBYTES08                                         | 2008-04-03 23:28:17.124000 |
| 0                    | 2006-01-02 15:12:05.000000 | 1008                 | 1009                 | 10.230000                                           | false                                               | 792345678.765432                                    | FOOBAR09                                            | SOMEBYTES09                                         | 2008-04-03 23:29:17.124000 |
| 0                    | 2006-01-02 15:13:05.000000 | 1009                 | 1010                 | 11.230000                                           | true                                                | 7102345678.765432                                   | FOOBAR10                                            | SOMEBYTES10                                         | 2008-04-03 23:30:17.124000 |
| 1                    | 2006-01-02 15:14:05.000000 | 1010                 | 1011                 | 12.230000                                           | false                                               | 7112345678.765432                                   | FOOBAR11                                            | SOMEBYTES011                                        | 2008-04-03 23:31:17.124000 |
| 1                    | 2006-01-02 15:15:05.000000 | 1011                 | 1012                 | 13.230000                                           | true                                                | 7122345678.765432                                   | FOOBAR12                                            | SOMEBYTES12                                         | 2008-04-03 23:32:17.124000 |
| 0                    | 2006-01-02 15:16:05.000000 | 1012                 | 1013                 | 14.230000                                           | false                                               | 7132345678.765432                                   | FOOBAR13                                            | SOMEBYTES13                                         | 2008-04-03 23:33:17.124000 |
| 1                    | 2006-01-02 15:17:05.000000 | 1013                 | 1014                 | 15.230000                                           | true                                                | 7142345678.765432                                   | FOOBAR14                                            | SOMEBYTES14                                         | 2008-04-03 23:34:17.124000 |
| 2                    | 2006-01-02 15:18:05.000000 | 1014                 | 1015                 | 16.230000                                           | false                                               | 7152345678.765432                                   | FOOBAR15                                            | SOMEBYTES15                                         | 2008-04-03 23:35:17.124000 |
| 0                    | 2006-01-02 15:19:05.000000 | 1015                 | 1016                 | 17.230000                                           | true                                                | 7162345678.765432                                   | FOOBAR16                                            | SOMEBYTES16                                         | 2008-04-03 23:36:17.124000 |
| 3                    | 2006-01-02 15:20:05.000000 | 1016                 | 1017                 | 18.230000                                           | false                                               | 7172345678.765432                                   | FOOBAR17                                            | SOMEBYTES17                                         | 2008-04-03 23:37:17.124000 |
| 1                    | 2006-01-02 15:21:05.000000 | 1017                 | 1018                 | 19.230000                                           | true                                                | 7182345678.765432                                   | FOOBAR18                                            | SOMEBYTES18                                         | 2008-04-03 23:38:17.124000 |
| 2                    | 2006-01-02 15:22:05.000000 | 1018                 | 1019                 | 20.230000                                           | false                                               | 7192345678.765432                                   | FOOBAR19                                            | SOMEBYTES19                                         | 2008-04-03 23:39:17.124000 |
| 2                    | 2006-01-02 15:23:05.000000 | 1020                 | 1021                 | 21.230000                                           | true                                                | 7202345678.765432                                   | FOOBAR20                                            | SOMEBYTES20                                         | 2008-04-03 23:40:17.124000 |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

(scan all from stream4) -> (sort by v0);
+--------------------------------------------------------------------------+
| offset               | event_time                 | v0                   |
+--------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 |
| 0                    | 2006-01-02 15:10:05.000000 | 1006                 |
| 0                    | 2006-01-02 15:12:05.000000 | 1008                 |
| 1                    | 2006-01-02 15:14:05.000000 | 1010                 |
| 0                    | 2006-01-02 15:16:05.000000 | 1012                 |
| 2                    | 2006-01-02 15:18:05.000000 | 1014                 |
| 3                    | 2006-01-02 15:20:05.000000 | 1016                 |
| 2                    | 2006-01-02 15:22:05.000000 | 1018                 |
| 2                    | 2006-01-02 15:23:05.000000 | 1020                 |
+--------------------------------------------------------------------------+
11 rows returned

-- test with wasm function in sort;

(scan all from stream1) -> (project v0, v2) -> (sort by test_mod1.funcBoolReturn(v2), v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| v0                   | v2                                                                                                                                                                                                                                                                                                                                                                                    |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 1000                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1002                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1004                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1006                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1008                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1010                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1012                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1014                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1016                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1018                 | true                                                                                                                                                                                                                                                                                                                                                                                  |
| 1001                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1003                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1005                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1007                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1009                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1011                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1013                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1015                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1017                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
| 1020                 | false                                                                                                                                                                                                                                                                                                                                                                                 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

-- now we restart to make sure modules are reloaded on restart;

--restart cluster;

(scan all from stream2) -> (sort by v0);
+----------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | all_str                                   |
+----------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1000 1.23 true 12345678.765432 foobar01.. |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 1001 2.23 false 22345678.765432 foobar0.. |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 1002 3.23 true 32345678.765432 foobar03.. |
| 0                    | 2006-01-02 15:07:05.000000 | 1003                 | 1003 4.23 false 42345678.765432 foobar0.. |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 1004 5.23 true 52345678.765432 foobar05.. |
| 0                    | 2006-01-02 15:09:05.000000 | 1005                 | 1005 6.23 false 62345678.765432 foobar0.. |
| 0                    | 2006-01-02 15:10:05.000000 | 1006                 | 1006 7.23 true 72345678.765432 foobar07.. |
| 1                    | 2006-01-02 15:11:05.000000 | 1007                 | 1007 8.23 false 82345678.765432 foobar0.. |
| 0                    | 2006-01-02 15:12:05.000000 | 1008                 | 1008 9.23 true 92345678.765432 foobar09.. |
| 0                    | 2006-01-02 15:13:05.000000 | 1009                 | 1009 10.23 false 102345678.765432 fooba.. |
| 1                    | 2006-01-02 15:14:05.000000 | 1010                 | 1010 11.23 true 112345678.765432 foobar.. |
| 1                    | 2006-01-02 15:15:05.000000 | 1011                 | 1011 12.23 false 122345678.765432 fooba.. |
| 0                    | 2006-01-02 15:16:05.000000 | 1012                 | 1012 13.23 true 132345678.765432 foobar.. |
| 1                    | 2006-01-02 15:17:05.000000 | 1013                 | 1013 14.23 false 142345678.765432 fooba.. |
| 2                    | 2006-01-02 15:18:05.000000 | 1014                 | 1014 15.23 true 152345678.765432 foobar.. |
| 0                    | 2006-01-02 15:19:05.000000 | 1015                 | 1015 16.23 false 162345678.765432 fooba.. |
| 3                    | 2006-01-02 15:20:05.000000 | 1016                 | 1016 17.23 true 172345678.765432 foobar.. |
| 1                    | 2006-01-02 15:21:05.000000 | 1017                 | 1017 18.23 false 182345678.765432 fooba.. |
| 2                    | 2006-01-02 15:22:05.000000 | 1018                 | 1018 19.23 true 192345678.765432 foobar.. |
| 2                    | 2006-01-02 15:23:05.000000 | 1020                 | 1020 20.23 false 202345678.765432 fooba.. |
+----------------------------------------------------------------------------------------------------------------------+
20 rows returned

(scan all from stream3) -> (sort by v0);
+-------------------------------------------------------------------------------------------------------------+
| offset   | event_.. | v0       | rv0      | rv1      | rv2      | rv3      | rv4      | rv5      | rv6      |
+-------------------------------------------------------------------------------------------------------------+
| 0        | 2006-0.. | 1000     | 1001     | 2.230000 | false    | 712345.. | FOOBAR01 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1001     | 1002     | 3.230000 | true     | 722345.. | FOOBAR02 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1002     | 1003     | 4.230000 | false    | 732345.. | FOOBAR03 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1003     | 1004     | 5.230000 | true     | 742345.. | FOOBAR04 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1004     | 1005     | 6.230000 | false    | 752345.. | FOOBAR05 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1005     | 1006     | 7.230000 | true     | 762345.. | FOOBAR06 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1006     | 1007     | 8.230000 | false    | 772345.. | FOOBAR07 | SOMEBY.. | 2008-0.. |
| 1        | 2006-0.. | 1007     | 1008     | 9.230000 | true     | 782345.. | FOOBAR08 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1008     | 1009     | 10.230.. | false    | 792345.. | FOOBAR09 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1009     | 1010     | 11.230.. | true     | 710234.. | FOOBAR10 | SOMEBY.. | 2008-0.. |
| 1        | 2006-0.. | 1010     | 1011     | 12.230.. | false    | 711234.. | FOOBAR11 | SOMEBY.. | 2008-0.. |
| 1        | 2006-0.. | 1011     | 1012     | 13.230.. | true     | 712234.. | FOOBAR12 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1012     | 1013     | 14.230.. | false    | 713234.. | FOOBAR13 | SOMEBY.. | 2008-0.. |
| 1        | 2006-0.. | 1013     | 1014     | 15.230.. | true     | 714234.. | FOOBAR14 | SOMEBY.. | 2008-0.. |
| 2        | 2006-0.. | 1014     | 1015     | 16.230.. | false    | 715234.. | FOOBAR15 | SOMEBY.. | 2008-0.. |
| 0        | 2006-0.. | 1015     | 1016     | 17.230.. | true     | 716234.. | FOOBAR16 | SOMEBY.. | 2008-0.. |
| 3        | 2006-0.. | 1016     | 1017     | 18.230.. | false    | 717234.. | FOOBAR17 | SOMEBY.. | 2008-0.. |
| 1        | 2006-0.. | 1017     | 1018     | 19.230.. | true     | 718234.. | FOOBAR18 | SOMEBY.. | 2008-0.. |
| 2        | 2006-0.. | 1018     | 1019     | 20.230.. | false    | 719234.. | FOOBAR19 | SOMEBY.. | 2008-0.. |
| 2        | 2006-0.. | 1020     | 1021     | 21.230.. | true     | 720234.. | FOOBAR20 | SOMEBY.. | 2008-0.. |
+-------------------------------------------------------------------------------------------------------------+
20 rows returned

(scan all from stream4) -> (sort by v0);
+--------------------------------------------------------------------------+
| offset               | event_time                 | v0                   |
+--------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 |
| 0                    | 2006-01-02 15:10:05.000000 | 1006                 |
| 0                    | 2006-01-02 15:12:05.000000 | 1008                 |
| 1                    | 2006-01-02 15:14:05.000000 | 1010                 |
| 0                    | 2006-01-02 15:16:05.000000 | 1012                 |
| 2                    | 2006-01-02 15:18:05.000000 | 1014                 |
| 3                    | 2006-01-02 15:20:05.000000 | 1016                 |
| 2                    | 2006-01-02 15:22:05.000000 | 1018                 |
| 2                    | 2006-01-02 15:23:05.000000 | 1020                 |
+--------------------------------------------------------------------------+
11 rows returned

(scan all from stream1) -> (project v0, v2) -> (sort by test_mod1.funcBoolReturn(v2), v0);
+----------------------------------------------------------------------------------------------------------------------+
| v0                   | v2                                                                                            |
+----------------------------------------------------------------------------------------------------------------------+
| 1000                 | true                                                                                          |
| 1002                 | true                                                                                          |
| 1004                 | true                                                                                          |
| 1006                 | true                                                                                          |
| 1008                 | true                                                                                          |
| 1010                 | true                                                                                          |
| 1012                 | true                                                                                          |
| 1014                 | true                                                                                          |
| 1016                 | true                                                                                          |
| 1018                 | true                                                                                          |
| 1001                 | false                                                                                         |
| 1003                 | false                                                                                         |
| 1005                 | false                                                                                         |
| 1007                 | false                                                                                         |
| 1009                 | false                                                                                         |
| 1011                 | false                                                                                         |
| 1013                 | false                                                                                         |
| 1015                 | false                                                                                         |
| 1017                 | false                                                                                         |
| 1020                 | false                                                                                         |
+----------------------------------------------------------------------------------------------------------------------+
20 rows returned

-- errors;

-- try to register unknown path;

register_wasm("no/such/path/test_mod1.wasm");
failed to read wasm file 'no/such/path/test_mod1.wasm: open no/such/path/test_mod1.wasm: no such file or directory

-- missing json file;

register_wasm("testdata/wasm/missing-json/missing-json.wasm");
failed to read wasm json file 'testdata/wasm/missing-json/missing-json.json: open testdata/wasm/missing-json/missing-json.json: no such file or directory

-- invalid wasm;

register_wasm("testdata/wasm/invalid-wasm/invalid.wasm");
failed to compile wasm module (possibly corrupt): invalid magic number

-- invalid json;

register_wasm("testdata/wasm/invalid-json/invalid-json.wasm");
failed to parse JSON: invalid character ',' looking for beginning of object key string

-- function params don't match actual wasm function params;

register_wasm("testdata/wasm/func-bad-params/func-bad-params.wasm");
function 'funcArgsAllTypes' as defined in the json metadata would require a wasm function with wasm parameter types [f64,i32,i64,i64,i64,i64]. But the actual wasm function has parameter types [i64,f64,i32,i64,i64,i64,i64]

-- function return value doesn't match actual wasm function return value;

register_wasm("testdata/wasm/func-bad-return/func-bad-return.wasm");
function 'funcArgsAllTypes' as defined in the json metadata would require a wasm function with return type i32. But the actual wasm function has return type i64

-- unknown function in loaded module;

stream5 := stream1 -> (project v0) -> (filter by test_mod1.wibbleFunc(v0)) -> (store stream);
'test_mod1.wibbleFunc' is not a known function (line 1 column 50):
stream5 := stream1 -> (project v0) -> (filter by test_mod1.wibbleFunc(v0)) -> (store stream)
                                                 ^

delete(stream4);
OK
delete(stream3);
OK
delete(stream2);
OK

-- unregister module, then try to deploy stream with function;

unregister_wasm("test_mod2");
OK

stream5 := stream1 -> (project v0) -> (filter by test_mod2.filterFunc(v0)) -> (store stream);
'test_mod2.filterFunc' is not a known function (line 1 column 50):
stream5 := stream1 -> (project v0) -> (filter by test_mod2.filterFunc(v0)) -> (store stream)
                                                 ^

register_wasm("testdata/wasm/test_mod2/test_mod2.wasm");
OK

delete(stream1);
OK

--delete topic test_topic;
