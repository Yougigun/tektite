set max_line_width 200;
OK
-- we set partitions to a small number so data gets loaded in more than one backfill batch;
--create topic test_topic 4;

stream1 :=
(bridge from test_topic partitions = 4 props = ())
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (store stream);
OK

-- load data into stream1 stream;

--load data dataset_1;

-- now create new streams on that stream - should backfill;

stream2 := stream1 -> (backfill)
-> (project v0, v1, v2, v3, v4, v5, v6)
-> (store stream);
OK

stream3 := stream1 -> (backfill)
-> (project v0, v1, v2, v3, v4, v5, v6)
-> (store stream);
OK

(scan all from stream2) -> (sort by v0);
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| 1                    | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 1                    | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| 1                    | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2                    | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| 2                    | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 3                    | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 3                    | 2006-01-02 15:14:05.000000 | 1010                 | 11.230000        | true             | 112345678.765432 | foobar11         | somebytes011     | 2008-04-03 23:31:17.123000 |
| 2                    | 2006-01-02 15:15:05.000000 | 1011                 | 12.230000        | false            | 122345678.765432 | foobar12         | somebytes12      | 2008-04-03 23:32:17.123000 |
| 1                    | 2006-01-02 15:16:05.000000 | 1012                 | 13.230000        | true             | 132345678.765432 | foobar13         | somebytes13      | 2008-04-03 23:33:17.123000 |
| 4                    | 2006-01-02 15:17:05.000000 | 1013                 | 14.230000        | false            | 142345678.765432 | foobar14         | somebytes14      | 2008-04-03 23:34:17.123000 |
| 4                    | 2006-01-02 15:18:05.000000 | 1014                 | 15.230000        | true             | 152345678.765432 | foobar15         | somebytes15      | 2008-04-03 23:35:17.123000 |
| 2                    | 2006-01-02 15:19:05.000000 | 1015                 | 16.230000        | false            | 162345678.765432 | foobar16         | somebytes16      | 2008-04-03 23:36:17.123000 |
| 5                    | 2006-01-02 15:20:05.000000 | 1016                 | 17.230000        | true             | 172345678.765432 | foobar17         | somebytes17      | 2008-04-03 23:37:17.123000 |
| 5                    | 2006-01-02 15:21:05.000000 | 1017                 | 18.230000        | false            | 182345678.765432 | foobar18         | somebytes18      | 2008-04-03 23:38:17.123000 |
| 6                    | 2006-01-02 15:22:05.000000 | 1018                 | 19.230000        | true             | 192345678.765432 | foobar19         | somebytes19      | 2008-04-03 23:39:17.123000 |
| 7                    | 2006-01-02 15:23:05.000000 | 1020                 | 20.230000        | false            | 202345678.765432 | foobar20         | somebytes20      | 2008-04-03 23:40:17.123000 |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

(scan all from stream3) -> (sort by v0);
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| 1                    | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 1                    | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| 1                    | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2                    | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| 2                    | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 3                    | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 3                    | 2006-01-02 15:14:05.000000 | 1010                 | 11.230000        | true             | 112345678.765432 | foobar11         | somebytes011     | 2008-04-03 23:31:17.123000 |
| 2                    | 2006-01-02 15:15:05.000000 | 1011                 | 12.230000        | false            | 122345678.765432 | foobar12         | somebytes12      | 2008-04-03 23:32:17.123000 |
| 1                    | 2006-01-02 15:16:05.000000 | 1012                 | 13.230000        | true             | 132345678.765432 | foobar13         | somebytes13      | 2008-04-03 23:33:17.123000 |
| 4                    | 2006-01-02 15:17:05.000000 | 1013                 | 14.230000        | false            | 142345678.765432 | foobar14         | somebytes14      | 2008-04-03 23:34:17.123000 |
| 4                    | 2006-01-02 15:18:05.000000 | 1014                 | 15.230000        | true             | 152345678.765432 | foobar15         | somebytes15      | 2008-04-03 23:35:17.123000 |
| 2                    | 2006-01-02 15:19:05.000000 | 1015                 | 16.230000        | false            | 162345678.765432 | foobar16         | somebytes16      | 2008-04-03 23:36:17.123000 |
| 5                    | 2006-01-02 15:20:05.000000 | 1016                 | 17.230000        | true             | 172345678.765432 | foobar17         | somebytes17      | 2008-04-03 23:37:17.123000 |
| 5                    | 2006-01-02 15:21:05.000000 | 1017                 | 18.230000        | false            | 182345678.765432 | foobar18         | somebytes18      | 2008-04-03 23:38:17.123000 |
| 6                    | 2006-01-02 15:22:05.000000 | 1018                 | 19.230000        | true             | 192345678.765432 | foobar19         | somebytes19      | 2008-04-03 23:39:17.123000 |
| 7                    | 2006-01-02 15:23:05.000000 | 1020                 | 20.230000        | false            | 202345678.765432 | foobar20         | somebytes20      | 2008-04-03 23:40:17.123000 |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

--restart cluster;

set max_line_width 200;
OK

(scan all from stream2) -> (sort by v0);
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| 1                    | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 1                    | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| 1                    | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2                    | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| 2                    | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 3                    | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 3                    | 2006-01-02 15:14:05.000000 | 1010                 | 11.230000        | true             | 112345678.765432 | foobar11         | somebytes011     | 2008-04-03 23:31:17.123000 |
| 2                    | 2006-01-02 15:15:05.000000 | 1011                 | 12.230000        | false            | 122345678.765432 | foobar12         | somebytes12      | 2008-04-03 23:32:17.123000 |
| 1                    | 2006-01-02 15:16:05.000000 | 1012                 | 13.230000        | true             | 132345678.765432 | foobar13         | somebytes13      | 2008-04-03 23:33:17.123000 |
| 4                    | 2006-01-02 15:17:05.000000 | 1013                 | 14.230000        | false            | 142345678.765432 | foobar14         | somebytes14      | 2008-04-03 23:34:17.123000 |
| 4                    | 2006-01-02 15:18:05.000000 | 1014                 | 15.230000        | true             | 152345678.765432 | foobar15         | somebytes15      | 2008-04-03 23:35:17.123000 |
| 2                    | 2006-01-02 15:19:05.000000 | 1015                 | 16.230000        | false            | 162345678.765432 | foobar16         | somebytes16      | 2008-04-03 23:36:17.123000 |
| 5                    | 2006-01-02 15:20:05.000000 | 1016                 | 17.230000        | true             | 172345678.765432 | foobar17         | somebytes17      | 2008-04-03 23:37:17.123000 |
| 5                    | 2006-01-02 15:21:05.000000 | 1017                 | 18.230000        | false            | 182345678.765432 | foobar18         | somebytes18      | 2008-04-03 23:38:17.123000 |
| 6                    | 2006-01-02 15:22:05.000000 | 1018                 | 19.230000        | true             | 192345678.765432 | foobar19         | somebytes19      | 2008-04-03 23:39:17.123000 |
| 7                    | 2006-01-02 15:23:05.000000 | 1020                 | 20.230000        | false            | 202345678.765432 | foobar20         | somebytes20      | 2008-04-03 23:40:17.123000 |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

(scan all from stream3) -> (sort by v0);
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| offset               | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 0                    | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| 0                    | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| 0                    | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| 1                    | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| 0                    | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| 1                    | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| 1                    | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| 2                    | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| 2                    | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| 3                    | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
| 3                    | 2006-01-02 15:14:05.000000 | 1010                 | 11.230000        | true             | 112345678.765432 | foobar11         | somebytes011     | 2008-04-03 23:31:17.123000 |
| 2                    | 2006-01-02 15:15:05.000000 | 1011                 | 12.230000        | false            | 122345678.765432 | foobar12         | somebytes12      | 2008-04-03 23:32:17.123000 |
| 1                    | 2006-01-02 15:16:05.000000 | 1012                 | 13.230000        | true             | 132345678.765432 | foobar13         | somebytes13      | 2008-04-03 23:33:17.123000 |
| 4                    | 2006-01-02 15:17:05.000000 | 1013                 | 14.230000        | false            | 142345678.765432 | foobar14         | somebytes14      | 2008-04-03 23:34:17.123000 |
| 4                    | 2006-01-02 15:18:05.000000 | 1014                 | 15.230000        | true             | 152345678.765432 | foobar15         | somebytes15      | 2008-04-03 23:35:17.123000 |
| 2                    | 2006-01-02 15:19:05.000000 | 1015                 | 16.230000        | false            | 162345678.765432 | foobar16         | somebytes16      | 2008-04-03 23:36:17.123000 |
| 5                    | 2006-01-02 15:20:05.000000 | 1016                 | 17.230000        | true             | 172345678.765432 | foobar17         | somebytes17      | 2008-04-03 23:37:17.123000 |
| 5                    | 2006-01-02 15:21:05.000000 | 1017                 | 18.230000        | false            | 182345678.765432 | foobar18         | somebytes18      | 2008-04-03 23:38:17.123000 |
| 6                    | 2006-01-02 15:22:05.000000 | 1018                 | 19.230000        | true             | 192345678.765432 | foobar19         | somebytes19      | 2008-04-03 23:39:17.123000 |
| 7                    | 2006-01-02 15:23:05.000000 | 1020                 | 20.230000        | false            | 202345678.765432 | foobar20         | somebytes20      | 2008-04-03 23:40:17.123000 |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
20 rows returned

delete(stream3);
OK
delete(stream2);
OK
delete(stream1);
OK

-- errors;

-- parent stream must be stored stream;

stream_not_stored :=
(bridge from test_topic partitions = 4 props = ())
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6);
OK

stream2 := stream_not_stored -> (backfill) -> (store stream);
parent stream 'stream_not_stored' must be a stored stream when there is a 'backfill' operator (line 1 column 34):
stream2 := stream_not_stored -> (backfill) -> (store stream)
                                 ^

delete(stream_not_stored);
OK

--delete topic test_topic;
