set max_line_width 200;
OK

-- many partitions;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (partition by v3 partitions=1000)
-> (store stream);
OK

--load data dataset_1;

(scan all from stream1) -> (project key, event_time, v0, v1, v2, v3, v4, v5, v6) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key              | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key01            | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| key02            | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| key03            | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| key04            | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| key05            | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| key06            | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| key07            | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| key08            | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| key09            | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| key10            | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

delete(stream1);
OK

--delete topic test_topic;

-- few partitions;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (partition by v3 partitions=2)
-> (store stream);
OK

--load data dataset_1;

(scan all from stream1) -> (project key, event_time, v0, v1, v2, v3, v4, v5, v6) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key              | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key01            | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| key02            | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| key03            | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| key04            | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| key05            | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| key06            | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| key07            | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| key08            | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| key09            | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| key10            | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

delete(stream1);
OK

--delete topic test_topic;

-- 1 partition;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (partition by v3 partitions=1)
-> (store stream);
OK

--load data dataset_1;

(scan all from stream1) -> (project key, event_time, v0, v1, v2, v3, v4, v5, v6) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key              | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key01            | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| key02            | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| key03            | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| key04            | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| key05            | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| key06            | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| key07            | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| key08            | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| key09            | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| key10            | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

delete(stream1);
OK

--delete topic test_topic;

-- partition(composite key;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (partition by v1, v2, v3 partitions=2)
-> (store stream);
OK

--load data dataset_1;

(scan all from stream1) -> (project key, event_time, v0, v1, v2, v3, v4, v5, v6) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key              | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key01            | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| key02            | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| key03            | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| key04            | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| key05            | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| key06            | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| key07            | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| key08            | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| key09            | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| key10            | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

delete(stream1);
OK

--delete topic test_topic;

-- chain of partitions;

--create topic test_topic 16;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0,
    json_float("v1",val) as v1,
    json_bool("v2",val) as v2,
    to_decimal(json_string("v3", val),38,6) as v3,
    json_string("v4", val) as v4,
    to_bytes(json_string("v5", val)) as v5,
    parse_date(json_string("v6", val), "2006-01-02 15:04:05.999999") as v6)
-> (partition by v0 partitions=10)
-> (partition by v1 partitions=12)
-> (partition by v2 partitions=3)
-> (partition by v3 partitions=100)
-> (store stream);
OK

--load data dataset_1;

(scan all from stream1) -> (project key, event_time, v0, v1, v2, v3, v4, v5, v6) -> (sort by v0);
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key              | event_time                 | v0                   | v1               | v2               | v3               | v4               | v5               | v6                         |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| key01            | 2006-01-02 15:04:05.000000 | 1000                 | 1.230000         | true             | 12345678.765432  | foobar01         | somebytes01      | 2008-04-03 23:21:17.123000 |
| key02            | 2006-01-02 15:05:05.000000 | 1001                 | 2.230000         | false            | 22345678.765432  | foobar02         | somebytes02      | 2008-04-03 23:22:17.123000 |
| key03            | 2006-01-02 15:06:05.000000 | 1002                 | 3.230000         | true             | 32345678.765432  | foobar03         | somebytes03      | 2008-04-03 23:23:17.123000 |
| key04            | 2006-01-02 15:07:05.000000 | 1003                 | 4.230000         | false            | 42345678.765432  | foobar04         | somebytes04      | 2008-04-03 23:24:17.123000 |
| key05            | 2006-01-02 15:08:05.000000 | 1004                 | 5.230000         | true             | 52345678.765432  | foobar05         | somebytes05      | 2008-04-03 23:25:17.123000 |
| key06            | 2006-01-02 15:09:05.000000 | 1005                 | 6.230000         | false            | 62345678.765432  | foobar06         | somebytes06      | 2008-04-03 23:26:17.123000 |
| key07            | 2006-01-02 15:10:05.000000 | 1006                 | 7.230000         | true             | 72345678.765432  | foobar07         | somebytes07      | 2008-04-03 23:27:17.123000 |
| key08            | 2006-01-02 15:11:05.000000 | 1007                 | 8.230000         | false            | 82345678.765432  | foobar08         | somebytes08      | 2008-04-03 23:28:17.123000 |
| key09            | 2006-01-02 15:12:05.000000 | 1008                 | 9.230000         | true             | 92345678.765432  | foobar09         | somebytes09      | 2008-04-03 23:29:17.123000 |
| key10            | 2006-01-02 15:13:05.000000 | 1009                 | 10.230000        | false            | 102345678.765432 | foobar10         | somebytes10      | 2008-04-03 23:30:17.123000 |
+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
10 rows returned

delete(stream1);
OK

-- errors;

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0)
-> (partition by v0 partitions=0);
invalid value for 'partitions' - must be > 0 (line 10 column 21):
-> (partition by v0 partitions=0)
                    ^

stream1 :=
(bridge from
    test_topic
    partitions = 16
    props = ()
)
-> (project
    key,
    json_int("v0",val) as v0)
-> (partition by foo partitions=10);
cannot use key column 'foo' in partition operator - it is not a known column in the incoming schema (line 10 column 5):
-> (partition by foo partitions=10)
    ^

--delete topic test_topic;
